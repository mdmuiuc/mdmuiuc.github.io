<html>
<script src="https://d3js.org/d3.v5.min.js"></script>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
</head>
<body onload='init()'>

<svg>
</svg>
<script>
async function init() {
  const data = await d3.csv("https://raw.githubusercontent.com/mdmuiuc/mdmuiuc.github.io/master/covid_data.csv", function(d) {
    var dateParts = d.dateRep.split("/");
    
    return {
      cases: d.cases,
      continent: d.continentExp,
      date: new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]),
      deaths: d.deaths,
      population: d.popData2019
    };
  });
  const dataByCountry = d3.nest()
    .key(function(d) { return d.continent; })
    .key(function(d) { return d.date; }).sortKeys((a, b) => d3.isoParse(a) < d3.isoParse(b)? 1 : -1)
    .rollup(function(v) { return {
      cases: d3.sum(v, function(d) { return d.cases; }),
      deaths: d3.sum(v, function(d) { return d.deaths; }),
      deathsPerCapita: d3.sum(v, function(d) { return d.deaths; })/
                       d3.sum(v, function(d) { return d.population; })
      }; 
    })
    .entries(data);
  
  var width = window.innerWidth;
  var height = window.innerHeight;
  var widthMargin = 50;//.1*width;
  var heightMargin = 50;//.1*height;
  var x = d3.scaleUtc().domain(d3.extent(data, d => d.date)).range([0,width-2*widthMargin]);
  
  var yCases = d3.scaleLinear().domain([0, 140000]).range([height-2*heightMargin,0]);
  var yDeaths = d3.scaleLinear().domain([0, 500]).range([height-2*heightMargin,0]);
  var yDeathsPerCapita = d3.scaleLinear().domain([0, 500]).range([height-2*widthMargin,0]);
  
  line = d3.line()
    //.defined(d => !isNaN(d))
    .x(d => x(d3.isoParse(d.key)))
    .y(d => yCases(d.value.cases));
  
  var testy = line(dataByCountry[0].values);
  
  d3.select("svg")
    .attr("viewBox", [0, 0, width, height])
    .append("g")
    .attr("transform", "translate("+heightMargin+","+widthMargin+")")
    .call(d3.axisLeft(yCases).ticks(height/100).tickFormat(d3.format("~s")));
  
  d3.select("svg")
    .append("g")
    .attr("transform", "translate("+widthMargin+","+(height-heightMargin)+")")
    .call(d3.axisBottom(x).ticks(width/100));
  
  d3.select("svg")
    .append("g")
    .attr("transform", "translate("+widthMargin+","+heightMargin+")")
    .attr("fill", "none")
    .attr("stroke-width", 1)
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .selectAll("path")
    .data(dataByCountry)
    .join("path")
    .style("mix-blend-mode", "multiply")
    .attr("stroke", (d, i) => ["red", "green", "steelblue", "orange", "brown", "black"][i])
    .attr("d", d => line(d.values));
  
   var a = "test";
}
</script>

</body>
</html>